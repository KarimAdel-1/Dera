#!/usr/bin/env node

/**
 * Update Frontend .env.local with Deployed Contract Addresses
 *
 * This script reads deployment-info.json and creates/updates frontend/.env.local
 * Run this after redeploying contracts
 */

const fs = require('fs');
const path = require('path');

const deploymentPath = path.join(__dirname, '..', 'contracts', 'deployment-info.json');
const envPath = path.join(__dirname, '.env.local');

if (!fs.existsSync(deploymentPath)) {
  console.error('âŒ deployment-info.json not found!');
  console.error('   Expected at: ' + deploymentPath);
  console.error('   Run: cd contracts && npx hardhat run scripts/deploy-complete.js --network testnet');
  process.exit(1);
}

const deployment = JSON.parse(fs.readFileSync(deploymentPath, 'utf8'));
const addresses = deployment.addresses;

const envContent = `# Dera Protocol - Frontend Environment Variables
# Autogenerated from deployment on ${deployment.timestamp}

# Network Configuration
NEXT_PUBLIC_HEDERA_NETWORK=${deployment.network || 'testnet'}
NEXT_PUBLIC_RPC_URL=https://testnet.hashio.io/api
NEXT_PUBLIC_MIRROR_NODE_URL=https://testnet.mirrornode.hedera.com

# Core Contract Addresses (from deployment-info.json)
NEXT_PUBLIC_POOL_ADDRESS=${addresses.POOL}
NEXT_PUBLIC_POOL_ADDRESSES_PROVIDER=${addresses.POOL_ADDRESSES_PROVIDER}
NEXT_PUBLIC_POOL_CONFIGURATOR=${addresses.POOL_CONFIGURATOR}
NEXT_PUBLIC_ACL_MANAGER=${addresses.ACL_MANAGER}
NEXT_PUBLIC_ORACLE_ADDRESS=${addresses.ORACLE}
NEXT_PUBLIC_RATE_STRATEGY=${addresses.RATE_STRATEGY}

# Additional Contracts
NEXT_PUBLIC_NODE_STAKING_ADDRESS=${addresses.MULTI_ASSET_STAKING}
NEXT_PUBLIC_ANALYTICS_ADDRESS=${addresses.ANALYTICS}

# Mock Mode (set to false for real contracts)
NEXT_PUBLIC_MOCK_MODE=false

# App Configuration
NEXT_PUBLIC_APP_NAME=Dera Protocol
NEXT_PUBLIC_APP_DESCRIPTION=DeFi Lending & Borrowing on Hedera
`;

fs.writeFileSync(envPath, envContent);

console.log('âœ… Frontend .env.local updated successfully!');
console.log('\nðŸ“‹ Contract Addresses:');
Object.entries(addresses).forEach(([name, address]) => {
  console.log(`   ${name.padEnd(30)} ${address}`);
});

console.log('\nðŸš€ Next Steps:');
console.log('   1. Restart your frontend dev server:');
console.log('      cd frontend && npm run dev');
console.log('   2. Verify deployment status:');
console.log('      node verify-new-deployment.js');
console.log('   3. Connect with HashPack and test!\n');
